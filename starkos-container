# 1) Vytvo≈ô si pracovn√≠ adres√°≈ô
mkdir -p ~/starkos-deb/starkos-container
cd ~/starkos-deb/starkos-container

# 2) Slo≈æen√≠ adres√°≈ôov√© struktury bal√≠ƒçku
mkdir -p \
 DEBIAN \
 usr/local/bin \
 etc/systemd/system \
 srv/starkos

# 3) Vlo≈æ instalaƒçn√≠ skript
# Skript je upraven pro bezobslu≈ænou instalaci a zahrnuje v≈°echny d≈ô√≠ve p≈ôidan√©
# funkce a kontroly.
cat > usr/local/bin/install-starkos.sh << 'EOF'
#!/usr/bin/env bash
#
# install-starkos.sh ‚Äî instalaƒçn√≠ soubor pro bal√≠ƒçek starkos-container
#
# Vylep≈°en√° verze s obsluhou chyb, volitelnou instalac√≠, vlastn√≠ ikonou,
# logov√°n√≠m a dynamickou konfigurac√≠ s√≠tƒõ pro bezobslu≈ænou instalaci.

set -euo pipefail

# ==============================================================================
# KONFIGURACE - M≈Ø≈æete upravit tyto promƒõnn√©
# ==============================================================================
MACHINE="starkos_kali"
BRIDGE="ve-$MACHINE"

# URL ke sta≈æen√≠ hlavn√≠ho souborov√©ho syst√©mu Kali Linux (rootfs) pro arm64.
# D≈ÆLE≈ΩIT√â: Tuto URL a kontroln√≠ souƒçet nahraƒète platn√Ωmi hodnotami
# z ofici√°ln√≠ch str√°nek Kali Linuxu.
TARBALL_URL="http://downloads.kali.org/kali-images/kali-2024.1/kali-linux-2024.1-live-arm64.tar.xz"
TARBALL_SHA256="zde_bude_aktualni_sha256_z_oficialniho_webu"

# Lok√°ln√≠ cesta k souboru MAKEJ Toolkit.
TOOLKIT_PATH="/home/starko/starkos-deb/Toolkit.tar.xz"
TOOLKIT_SHA256="zde_bude_sha256_toolkit_tarballu"

# URL ke sta≈æen√≠ ikony pro spou≈°tƒõc√≠ skript na plo≈°e.
ICON_URL="https://drive.google.com/file/d/18l2RCjDZpCUh2G3YRqkzJnTIUBcmre8-/view?usp=sharing"
ICON_SHA256="zde_bude_sha256_ikony"

# Cesty na hostitelsk√©m syst√©mu
INSTALL_DIR="/srv"
ROOTFS_DIR="${INSTALL_DIR}/${MACHINE}"
NSPNAP_CONF="/etc/systemd/nspawn/${MACHINE}.nspawn"
START_SCRIPT="/usr/local/bin/start_${MACHINE}.sh"
STOP_SCRIPT="/usr/local/bin/stop_${MACHINE}.sh"
DESKTOP_ICON_DIR="/home/$SUDO_USER/Desktop"
ICON_PATH="/usr/share/icons/hicolor/128x128/apps/starkos.png"
DESKTOP_FILE="${DESKTOP_ICON_DIR}/start_${MACHINE}.desktop"

# Logovac√≠ soubor a doƒçasn√Ω adres√°≈ô
LOG_FILE="/var/log/starkos_install.log"
TEMP_DIR=""
TARBALL_NAME=$(basename "$TARBALL_URL")
TOOLKIT_NAME=$(basename "$TOOLKIT_PATH")

# ==============================================================================
# FUNKCE
# ==============================================================================

# Funkce pro √∫klid doƒçasn√Ωch soubor≈Ø a adres√°≈ô≈Ø a z√°vƒõreƒçn√© hl√°≈°en√≠
cleanup() {
  local exit_code=$?
  if [ -n "$TEMP_DIR" ] && [ -d "$TEMP_DIR" ]; then
    log "‚ö†Ô∏è  Do≈°lo k chybƒõ. Prov√°d√≠m √∫klid doƒçasn√©ho adres√°≈ôe: $TEMP_DIR"
    rm -rf "$TEMP_DIR"
  fi
  if [ "$exit_code" -eq 0 ]; then
    [ "$USE_DIALOG" = true ] && zenity --info --title="Instalace StarkOS" --text="‚úÖ Instalace dokonƒçena!\n\nPr≈Øbƒõh instalace naleznete v log souboru:\n<b>${LOG_FILE}</b>\n\nNa plo≈°e byla vytvo≈ôena ikona 'Spustit StarkOS'."
  else
    [ "$USE_DIALOG" = true ] && zenity --error --title="Chyba instalace" --text="‚ùå Instalace StarkOS selhala! Bli≈æ≈°√≠ detaily naleznete v log souboru:\n<b>${LOG_FILE}</b>"
  fi
  exit "$exit_code"
}

# Funkce pro logov√°n√≠ na konzoli i do souboru
log() {
  echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

# Funkce pro zobrazen√≠ n√°povƒõdy
show_help() {
  cat << EOF
Pou≈æit√≠: sudo ./install-starkos.sh [mo≈ænosti]

Instalaƒçn√≠ skript pro StarkOS Lab na Raspberry Pi 5.

Mo≈ænosti:
  --help, -h          Zobraz√≠ tuto n√°povƒõdu.
  --no-dialog         Spust√≠ instalaci bez grafick√Ωch Zenity dialog≈Ø.
  --skip-tools        P≈ôeskoƒç√≠ instalaci u≈æiteƒçn√Ωch n√°stroj≈Ø (tmux, zsh atd.).
  --skip-toolkit      P≈ôeskoƒç√≠ instalaci sady n√°stroj≈Ø MAKEJ Toolkit.

EOF
  exit 0
}

# Funkce pro sta≈æen√≠/pou≈æit√≠ souboru s ovƒõ≈ôen√≠m integrity (s progress barem)
download_or_copy_and_verify() {
  local source="$1"
  local dest_path="$2"
  local expected_sha256="$3"
  local description="$4"

  log "‚¨áÔ∏è  Zpracov√°v√°m ${description}..."

  if [[ "$source" =~ ^https?:// ]]; then
    # Jedn√° se o URL, stahuji soubor
    if [ -f "$dest_path" ]; then
      [ "$USE_DIALOG" = true ] && zenity --info --title="Stahov√°n√≠" --text="Soubor pro ${description} ji≈æ existuje, stahov√°n√≠ se p≈ôeskoƒç√≠." || echo "Soubor ji≈æ existuje, p≈ôeskoƒçeno."
    else
      if [ "$USE_DIALOG" = true ]; then
        wget --progress=bar:force:noscroll -O "$dest_path" "$source" 2>&1 | \
        zenity --progress --title="Stahov√°n√≠ ${description}" --text="Prob√≠h√° stahov√°n√≠ z:\n${source}" --pulsate --no-cancel --auto-close
      else
        wget -O "$dest_path" "$source"
      fi
    fi
  elif [ -f "$source" ]; then
    # Jedn√° se o lok√°ln√≠ soubor, kop√≠ruji ho
    log "   Pou≈æ√≠v√°m lok√°ln√≠ soubor: $source"
    cp "$source" "$dest_path"
  else
    log "‚ùå  Chyba: Neplatn√Ω zdroj pro ${description}."
    exit 1
  fi

  log "üîç  Ovƒõ≈ôuji integritu souboru ${description}..."
  actual_sha256=$(sha256sum "$dest_path" | awk '{print $1}')

  if [ "$actual_sha256" != "$expected_sha256" ]; then
    log "‚ùå  Chyba: Kontroln√≠ souƒçet SHA256 se neshoduje!"
    log "    Oƒçek√°v√°no:   $expected_sha256"
    log "    Nalezeno:    $actual_sha256"
    exit 1
  fi
  log "‚úÖ  Integrita ovƒõ≈ôena."
}

# Funkce pro rozbalen√≠ tarballu
extract_tarball() {
  local tarball="$1"
  local dest_dir="$2"
  local description="$3"

  if [ -d "$dest_dir" ] && [ "$(ls -A "$dest_dir")" ]; then
    log "   (adres√°≈ô $dest_dir existuje a nen√≠ pr√°zdn√Ω, p≈ôeskoƒçeno rozbalen√≠)"
  else
    log "üìÇ Rozbaluji ${description} do $dest_dir..."
    mkdir -p "$dest_dir"
    tar -xJf "$tarball" -C "$dest_dir"
  fi
}

# Funkce pro pre-flight kontroly
pre_flight_checks() {
  log "üîç Prov√°d√≠m √∫vodn√≠ kontroly..."
  
  # Kontrola opr√°vnƒõn√≠ root
  if [ "$EUID" -ne 0 ]; then
    [ "$USE_DIALOG" = true ] && zenity --error --title="Chyba opr√°vnƒõn√≠" --text="‚ùå Tento skript mus√≠ b√Ωt spu≈°tƒõn s opr√°vnƒõn√≠m root (nap≈ô. p≈ôes sudo)."
    exit 1
  fi
  if [ -z "${SUDO_USER}" ]; then
    [ "$USE_DIALOG" = true ] && zenity --error --title="Chyba opr√°vnƒõn√≠" --text="‚ùå Spus≈•te skript p≈ôes 'sudo'!"
    exit 1
  fi

  # Kontrola dostupnosti p≈ô√≠kaz≈Ø
  local needed_commands="wget tar systemd-nspawn sha256sum"
  for cmd in $needed_commands; do
    if ! command -v "$cmd" &>/dev/null; then
      log "‚ö†Ô∏è  P≈ô√≠kaz '$cmd' nebyl nalezen. Pokou≈°√≠m se nainstalovat..."
      apt-get update
      apt-get install -y "$cmd" || { log "‚ùå  Nepoda≈ôilo se nainstalovat '$cmd'. Ukonƒçuji."; exit 1; }
      log "‚úÖ  P≈ô√≠kaz '$cmd' √∫spƒõ≈°nƒõ nainstalov√°n."
    fi
  done
  
  # Kontrola z√°stupn√Ωch SHA256
  if [[ "$TARBALL_SHA256" == "zde_bude_aktualni_sha256_z_oficialniho_webu" ]]; then
    log "‚ùå  Chyba: Kontroln√≠ souƒçet TARBALL_SHA256 nen√≠ definov√°n. Zmƒõ≈àte z√°stupnou hodnotu v CONFIGURATION."
    exit 1
  fi
  if [ "$INSTALL_TOOLKIT" = true ] && [[ "$TOOLKIT_SHA256" == "zde_bude_sha256_toolkit_tarballu" ]]; then
    log "‚ùå  Chyba: Kontroln√≠ souƒçet TOOLKIT_SHA256 nen√≠ definov√°n. Zmƒõ≈àte z√°stupnou hodnotu v CONFIGURATION."
    exit 1
  fi
  if [[ "$ICON_SHA256" == "zde_bude_sha256_ikony" ]]; then
    log "‚ùå  Chyba: Kontroln√≠ souƒçet ICON_SHA256 nen√≠ definov√°n. Zmƒõ≈àte z√°stupnou hodnotu v CONFIGURATION."
    exit 1
  fi
  
  log "‚úÖ √övodn√≠ kontroly dokonƒçeny."
}

# ==============================================================================
# HLAVN√ç ƒå√ÅST SKRIPTU
# ==============================================================================

# Zpracov√°n√≠ argument≈Ø p≈ô√≠kazov√© ≈ô√°dky
USE_DIALOG=true
INSTALL_TOOLS=true
INSTALL_TOOLKIT=true
for arg in "$@"; do
  case $arg in
    -h|--help)
      show_help
      ;;
    --no-dialog)
      USE_DIALOG=false
      ;;
    --skip-tools)
      INSTALL_TOOLS=false
      ;;
    --skip-toolkit)
      INSTALL_TOOLKIT=false
      ;;
  esac
done

# Nastaven√≠ pasti na sign√°l EXIT a ERR pro spu≈°tƒõn√≠ √∫klidov√© funkce
trap cleanup EXIT ERR

# Vytvo≈ôen√≠ doƒçasn√©ho adres√°≈ôe a log souboru
TEMP_DIR=$(mktemp -d)
echo "--------------------------------------------------------" | tee "$LOG_FILE"
log "Spu≈°tƒõna instalace StarkOS..."

# Vol√°n√≠ pre-flight kontrol
pre_flight_checks

# Uv√≠t√°n√≠ u≈æivatele
[ "$USE_DIALOG" = true ] && zenity --info --title="Instalace StarkOS" --text="V√≠tejte v instalaƒçn√≠m skriptu StarkOS!\n\nSkript provede n√°sleduj√≠c√≠ kroky:\n- Kontrola a instalace z√°vislost√≠\n- Sta≈æen√≠ a rozbalen√≠ Kali rootfs\n- Vytvo≈ôen√≠ spou≈°tƒõc√≠ch a vyp√≠nac√≠ch skript≈Ø\n- Vytvo≈ôen√≠ ikony na plochu"

# Instalace z√°vislost√≠, kter√© Zenity pot≈ôebuje a jsou d≈Øle≈æit√© pro kontejner
log "üîß Instalace z√°vislost√≠..."
apt-get update
apt-get install -y wget tar systemd-container coreutils zenity

# Dynamick√° detekce DNS
log "üîç Zji≈°≈•uji dynamicky DNS server a v√Ωchoz√≠ br√°nu..."
PRIMARY_DNS=$(grep -m1 '^nameserver' /etc/resolv.conf | awk '{print $2}' || echo "8.8.8.8")
log "   Detekovan√Ω DNS server: $PRIMARY_DNS"

# Sta≈æen√≠ a ovƒõ≈ôen√≠ Kali rootfs
download_or_copy_and_verify "$TARBALL_URL" "${TEMP_DIR}/${TARBALL_NAME}" "$TARBALL_SHA256" "Kali rootfs"

# Rozbalen√≠ Kali rootfs
extract_tarball "${TEMP_DIR}/${TARBALL_NAME}" "$ROOTFS_DIR" "Kali rootfs"

# Sta≈æen√≠ a instalace ikony
log "üñºÔ∏è  Stahuji a instaluji ikonu..."
mkdir -p "$(dirname "$ICON_PATH")"
download_or_copy_and_verify "$ICON_URL" "$ICON_PATH" "$ICON_SHA256" "ikonu pro StarkOS"
chmod 644 "$ICON_PATH"

# Instalace dal≈°√≠ch u≈æiteƒçn√Ωch n√°stroj≈Ø
if [ "$INSTALL_TOOLS" = true ]; then
  log "üõ†Ô∏è  Instaluji dal≈°√≠ u≈æiteƒçn√© n√°stroje do kontejneru..."
  systemd-nspawn -qD "$ROOTFS_DIR" /bin/bash << 'EOC'
    apt-get update
    apt-get install -y tmux zsh neovim git powerline
    echo "source /usr/share/powerline/bindings/zsh/powerline.sh" >> /etc/zsh/zshrc
    chsh -s /usr/bin/zsh kali
EOC
  log "‚úÖ Instalace n√°stroj≈Ø do kontejneru dokonƒçena."
fi

# Voliteln√° instalace MAKEJ Toolkit Ultra
if [ "$INSTALL_TOOLKIT" = true ]; then
  # Pokud je aktivn√≠ dialog, zept√° se u≈æivatele
  if [ "$USE_DIALOG" = true ]; then
    if ! zenity --question --title="Voliteln√° instalace" --text="Chcete nainstalovat sadu n√°stroj≈Ø MAKEJ Toolkit Ultra? Lok√°ln√≠ soubor bude pou≈æit z: ${TOOLKIT_PATH}"; then
      log "‚ÑπÔ∏è  Instalace MAKEJ Toolkitu p≈ôeskoƒçena na ≈æ√°dost u≈æivatele."
      INSTALL_TOOLKIT=false
    fi
  fi
  # Pokud je instalace povolena (buƒè defaultnƒõ, nebo u≈æivatelem)
  if [ "$INSTALL_TOOLKIT" = true ]; then
    log "üîß Instaluji MAKEJ Toolkit Ultra z lok√°ln√≠ cesty: ${TOOLKIT_PATH}"
    download_or_copy_and_verify "$TOOLKIT_PATH" "${TEMP_DIR}/${TOOLKIT_NAME}" "$TOOLKIT_SHA256" "MAKEJ Toolkit Ultra"
    extract_tarball "${TEMP_DIR}/${TOOLKIT_NAME}" "$ROOTFS_DIR/makej_toolkit" "MAKEJ Toolkit Ultra"
  fi
fi

# Vygenerov√°n√≠ .nspawn konfigurace s dynamick√Ωm DNS
log "‚öôÔ∏è  Vytv√°≈ô√≠m $NSPNAP_CONF s dynamick√Ωm nastaven√≠m s√≠tƒõ..."
mkdir -p "$(dirname "$NSPNAP_CONF")"
cat > "$NSPNAP_CONF" <<-EOF
[Exec]
Boot=yes

[Network]
VirtualEthernet=yes
Bridge=$BRIDGE
DNS=$PRIMARY_DNS

[Files]
Bind=/tmp/.X11-unix:/tmp/.X11-unix
EOF

# Generov√°n√≠ spou≈°tƒõc√≠ho skriptu
log "üöÄ Vytv√°≈ô√≠m startovac√≠ skript $START_SCRIPT..."
cat > "$START_SCRIPT" <<-EOF
#!/usr/bin/env bash
xhost +local:
exec systemd-nspawn -qD "$ROOTFS_DIR" \
  --hostname=$MACHINE \
  --network-bridge=$BRIDGE \
  --setenv=DISPLAY="\$DISPLAY" \
  --bind=/tmp/.X11-unix:/tmp/.X11-unix \
  --boot
EOF
chmod +x "$START_SCRIPT"

# Generov√°n√≠ vyp√≠nac√≠ho skriptu
log "üõë Vytv√°≈ô√≠m vyp√≠nac√≠ skript $STOP_SCRIPT..."
cat > "$STOP_SCRIPT" <<-EOF
#!/usr/bin/env bash
machinectl terminate $MACHINE || log "‚ö†Ô∏è  Nepoda≈ôilo se ukonƒçit $MACHINE."
EOF
chmod +x "$STOP_SCRIPT"

# Vytvo≈ôen√≠ ikony na plochu
log "üñºÔ∏è  Vytv√°≈ô√≠m ikonu na plochu pro u≈æivatele ${SUDO_USER}..."
mkdir -p "$DESKTOP_ICON_DIR"
cat > "$DESKTOP_FILE" <<-EOF
[Desktop Entry]
Version=1.0
Type=Application
Name=Spustit StarkOS
Comment=Spust√≠ izolovan√© kontejnerov√© prost≈ôed√≠ StarkOS
Exec=pkexec $START_SCRIPT
Terminal=false
Icon=starkos
Path=
Categories=System;
EOF
chown "$SUDO_USER":"$SUDO_USER" "$DESKTOP_FILE"
chmod +x "$DESKTOP_FILE"

# Hotovo - √∫klid a z√°vƒõreƒçn√° zpr√°va jsou zaji≈°tƒõny pomoc√≠ trap
log "‚úÖ Instalace dokonƒçena! Prov√°d√≠m fin√°ln√≠ √∫klid a ukonƒçuji skript."
EOF
chmod 755 usr/local/bin/install-starkos.sh

# 4) Vlo≈æ spou≈°tƒõc√≠/vyp√≠nac√≠ skripty
cat > usr/local/bin/start_starkos.sh << 'EOF'
#!/usr/bin/env bash
xhost +local:
exec systemd-nspawn -qD /srv/starkos \
  --hostname=starkos \
  --network-bridge=ve-starkos \
  --setenv=DISPLAY="$DISPLAY" \
  --bind=/tmp/.X11-unix:/tmp/.X11-unix \
  --boot
EOF
chmod 755 usr/local/bin/start_starkos.sh

cat > usr/local/bin/stop_starkos.sh << 'EOF'
#!/usr/bin/env bash
machinectl terminate starkos || echo "‚ö†Ô∏è  StarkOS nebyl spu≈°tƒõn."
EOF
chmod 755 usr/local/bin/stop_starkos.sh

# 5) Service unit pro automatick√© spu≈°tƒõn√≠ kontejneru (voliteln√©)
cat > etc/systemd/system/starkos-container.service << 'EOF'
[Unit]
Description=StarkOS izolovan√Ω kontejner
After=network.target

[Service]
Type=notify
ExecStart=/usr/local/bin/start_starkos.sh
ExecStop=/usr/local/bin/stop_starkos.sh
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

# 6) DEBIAN/control
cat > DEBIAN/control << 'EOF'
Package: starkos-container
Version: 1.0.0
Section: utils
Priority: optional
Architecture: arm64
Maintainer: Jacob <jacob@starkos.local>
Depends: systemd-container, wget, tar
Description: StarkOS v1.0 ‚Äì Ultra Kali Container Environment (CZ)
 Izolovan√Ω Kali-based kontejner s GUI (X11 + VNC),   
 ƒçeskou lokalizac√≠ a MAKEJ Toolkit Ultra.
EOF

# 7) DEBIAN/postinst (instalaƒçn√≠ kroky)
cat > DEBIAN/postinst << 'EOF'
#!/bin/sh
set -e
# povolit a spustit syst√©movou slu≈æbu
systemctl daemon-reload
systemctl enable starkos-container.service
echo "‚úÖ starkos-container.service povolena"
exit 0
EOF
chmod 755 DEBIAN/postinst

# 8) DEBIAN/prerm (p≈ôed odinstalac√≠)
cat > DEBIAN/prerm << 'EOF'
#!/bin/sh
set -e
# zastavit a zak√°zat slu≈æbu
systemctl disable starkos-container.service || true
systemctl stop starkos-container.service || true
exit 0
EOF
chmod 755 DEBIAN/prerm

# 9) Napl≈à /srv/starkos (stavov√Ω placeholder)
echo "Verze=StarkOS-v1.0" > srv/starkos/version.txt
mkdir -p srv/starkos/custom
echo "# sem vkl√°dej sv√© skripty a n√°stroje" > srv/starkos/custom/README.txt

# 10) Vytvo≈ôen√≠ .deb bal√≠ƒçku
cd ~/starkos-deb
dpkg-deb --build starkos-container

# V√Ωsledek: ~/starkos-deb/starkos-container.deb
echo "Hotovo! Bal√≠ƒçek najde≈° zde:"
echo "  ~/starkos-deb/starkos-container.deb"