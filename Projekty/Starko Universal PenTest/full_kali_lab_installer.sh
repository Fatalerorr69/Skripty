#!/bin/bash
# =========================================================================
# üõ°Ô∏è Starko Universal PenTest Installer (Komplexn√≠ verze)
# Autor: Gemini (na z√°kladƒõ p≈Øvodn√≠ho k√≥du)
# Popis: Tento skript nab√≠z√≠ v√Ωbƒõr ze t≈ô√≠ instalaƒçn√≠ch sad pro Kali Linux.
#        Kombinuje a vylep≈°uje p≈Øvodn√≠ skripty pro maxim√°ln√≠ bezpeƒçnost,
#        robustnost a p≈ôehlednost.
# =========================================================================

set -e
trap 'echo "üö® Instalace selhala. Zkontrolujte chybovou zpr√°vu." >&2' ERR

echo "=== üöÄ Spou≈°t√≠m komplexn√≠ instalaci Starko PenTest Labu ==="

# Kontrola root opr√°vnƒõn√≠
if [[ $EUID -ne 0 ]]; then
   echo "Tento skript mus√≠ b√Ωt spu≈°tƒõn s opr√°vnƒõn√≠m root. Pou≈æijte 'sudo bash' nebo 'sudo ./full_kali_lab_installer.sh'."
   exit 1
fi

# Z√≠sk√°n√≠ u≈æivatelsk√©ho jm√©na, pod kter√Ωm bude instalace prob√≠hat
if [[ -z "$SUDO_USER" ]]; then
    USER_NAME=$(whoami)
else
    USER_NAME=$SUDO_USER
fi
HOME_DIR="/home/$USER_NAME"

# =========================================================================
# FUNKCE PRO JEDNOTLIV√â INSTALACE
# =========================================================================

# --- Funkce pro instalaci Starko PenTest Dashboardu ---
install_starko_suite() {
    echo "=== üöÄ Spou≈°t√≠m instalaci Starko PenTest Dashboardu ==="
    PROJECT_DIR="$HOME_DIR/starko_pentest_project"
    VENV_DIR="$HOME_DIR/pentest-venv"

    # Zabezpeƒçen√≠: Generov√°n√≠ n√°hodn√Ωch hesel
    echo "=== üîí Generuji bezpeƒçn√° n√°hodn√° hesla..."
    POSTGRES_PASSWORD=$(openssl rand -base64 12)
    ADMIN_PASSWORD=$(openssl rand -base64 12)

    # KROK 1: Aktualizace syst√©mu a instalace z√°kladn√≠ch bal√≠ƒçk≈Ø
    echo "=== üîÑ KROK 1: Aktualizuji syst√©m a instaluji z√°kladn√≠ bal√≠ƒçky..."
    apt-get update -y
    apt-get upgrade -y
    apt-get autoremove -y
    apt-get install -y curl wget git vim nano htop tmux build-essential zsh openjdk-17-jdk python3 python3-pip python3-venv postgresql redis-server

    # KROK 2: Instalace penetraƒçn√≠ch n√°stroj≈Ø
    echo "=== üõ†Ô∏è KROK 2: Instaluji penetraƒçn√≠ n√°stroje..."
    if ! command -v metasploit-framework &>/dev/null; then
        apt-get install -y metasploit-framework wireshark aircrack-ng hashcat john hydra gobuster sqlmap burpsuite nikto
    fi

    # KROK 3: Vylep≈°en√≠ pracovn√≠ho prost≈ôed√≠ (termin√°l, editory)
    echo "=== üé® KROK 3: Upravuji pracovn√≠ plochu a prost≈ôed√≠..."
    if [ ! -d "$HOME_DIR/.oh-my-zsh" ]; then
        sh -c "$(wget -O- https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended || true
        chsh -s "$(which zsh)" "$USER_NAME"
    fi

    if [ ! -d "${ZSH_CUSTOM:-$HOME_DIR/.oh-my-zsh/custom}/themes/powerlevel10k" ]; then
        sudo -u "$USER_NAME" git clone --depth=1 https://github.com/romkatv/powerlevel10k.git "${ZSH_CUSTOM:-$HOME_DIR/.oh-my-zsh/custom}/themes/powerlevel10k"
    fi
    sed -i '/ZSH_THEME/s/".*"/"powerlevel10k\/powerlevel10k"/' "$HOME_DIR/.zshrc"
    sed -i '/plugins=/s/plugins=(git)/plugins=(git zsh-autosuggestions zsh-syntax-highlighting)/' "$HOME_DIR/.zshrc"
    chown "$USER_NAME:$USER_NAME" "$HOME_DIR/.zshrc"

    apt-get install -y tilix codium

    # KROK 4: Konfigurace datab√°ze a projektu Django
    echo "=== ‚öôÔ∏è KROK 4: Konfiguruji datab√°zi PostgreSQL..."
    sudo -u postgres psql -c "CREATE DATABASE pentest_db;" || true
    sudo -u postgres psql -c "CREATE USER pentest_user WITH PASSWORD '$POSTGRES_PASSWORD';" || true
    sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE pentest_db TO pentest_user;"

    echo "=== üì¶ KROK 5: P≈ô√≠prava prost≈ôed√≠ Python a instalace z√°vislost√≠..."
    sudo -u "$USER_NAME" mkdir -p "$PROJECT_DIR"
    cd "$PROJECT_DIR"
    cat <<EOF > requirements.txt
Django~=5.0
psycopg2-binary
gunicorn
channels
redis
celery
djangorestframework
EOF
    sudo -u "$USER_NAME" python3 -m venv "$VENV_DIR"
    source "$VENV_DIR/bin/activate"
    sudo -u "$USER_NAME" pip install --upgrade pip
    sudo -u "$USER_NAME" pip install -r requirements.txt
    sudo -u "$USER_NAME" django-admin startproject pentest_project .
    sudo -u "$USER_NAME" python manage.py startapp dashboard
    sudo -u "$USER_NAME" python manage.py makemigrations dashboard
    sudo -u "$USER_NAME" python manage.py migrate
    echo "from django.contrib.auth import get_user_model; User = get_user_model(); User.objects.create_superuser('admin', 'admin@example.com', '$ADMIN_PASSWORD')" | sudo -u "$USER_NAME" python manage.py shell

    # KROK 6: Automatick√© nasazen√≠ pomoc√≠ systemd
    echo "=== üöÄ KROK 6: Nasazuji webov√Ω dashboard pomoc√≠ systemd..."
    cat <<EOF | sudo tee /etc/systemd/system/gunicorn.service
[Unit]
Description=Gunicorn instance for Starko PenTest Dashboard
After=network.target

[Service]
User=$USER_NAME
Group=$USER_NAME
WorkingDirectory=$PROJECT_DIR
ExecStart=$VENV_DIR/bin/gunicorn --workers 3 --bind 0.0.0.0:8000 pentest_project.wsgi:application

[Install]
WantedBy=multi-user.target
EOF
    cat <<EOF | sudo tee /etc/systemd/system/celery.service
[Unit]
Description=Celery Worker for Starko PenTest Dashboard
After=network.target

[Service]
User=$USER_NAME
Group=$USER_NAME
WorkingDirectory=$PROJECT_DIR
ExecStart=$VENV_DIR/bin/celery -A pentest_project worker --loglevel=info

[Install]
WantedBy=multi-user.target
EOF
    systemctl daemon-reload
    systemctl start gunicorn celery
    systemctl enable gunicorn celery
    echo "Starko PenTest Dashboard by mƒõl b√Ωt nyn√≠ dostupn√Ω na http://VA≈†E_IP_ADRESA:8000"
    echo "P≈ôihla≈°ovac√≠ √∫daje administr√°tora: U≈æivatel: admin, Heslo: $ADMIN_PASSWORD"
    echo "Datab√°ze PostgreSQL: U≈æivatel: pentest_user, Heslo: $POSTGRES_PASSWORD"
    echo "=== ‚úÖ Instalace Starko dashboardu dokonƒçena! ==="
}

# --- Funkce pro instalaci AI k√≥dovac√≠ho serveru ---
install_ai_suite() {
    echo "=== üöÄ Spou≈°t√≠m instalaci AI k√≥dovac√≠ho serveru ==="
    cd "$HOME_DIR"
    sudo apt-get update -y
    sudo apt-get upgrade -y
    sudo apt-get install -y git python3 python3-venv python3-dev build-essential wget curl

    if lspci | grep -i nvidia > /dev/null; then
        echo "Nalezen NVIDIA GPU ‚Äì instaluji CUDA toolkit..."
        sudo apt-get install -y nvidia-cuda-toolkit
    else
        echo "NVIDIA GPU nebyla nalezena ‚Äì WebUI pobƒõ≈æ√≠ na CPU."
    fi

    if [ ! -d "$HOME_DIR/text-generation-webui" ]; then
        sudo -u "$USER_NAME" git clone https://github.com/oobabooga/text-generation-webui.git "$HOME_DIR/text-generation-webui"
    fi

    cd "$HOME_DIR/text-generation-webui"
    sudo -u "$USER_NAME" python3 -m venv venv
    source venv/bin/activate
    sudo -u "$USER_NAME" pip install --upgrade pip
    sudo -u "$USER_NAME" pip install -r requirements.txt

    echo "Stahuji model Code LLaMA 3 Instruct (GGUF)..."
    MODEL_DIR="$HOME_DIR/text-generation-webui/models/code-llama-3-7b-instruct"
    sudo -u "$USER_NAME" mkdir -p "$MODEL_DIR"
    sudo -u "$USER_NAME" wget -O "$MODEL_DIR/code-llama-3-7b-instruct.Q4_K_M.gguf" \
      https://huggingface.co/TheBloke/Code-LLaMA-3-7B-Instruct-GGUF/resolve/main/code-llama-3-7b-instruct.Q4_K_M.gguf

    cd "$HOME_DIR/text-generation-webui"

    # Odstranƒõn√≠ nebezpeƒçn√©ho API, pokud by existovalo
    sed -i '/@app.route("run-command")/d' server.py
    sed -i '/def run_command()/d' server.py
    sed -i '/import subprocess, shlex/d' server.py

    # Vytvo≈ôen√≠ startovac√≠ho skriptu
    cat << 'EOF' | sudo -u "$USER_NAME" tee "$HOME_DIR/start-webui.sh"
#!/bin/bash
cd ~/text-generation-webui
source venv/bin/activate
python server.py --listen --api --model code-llama-3-7b-instruct \
--extensions cz-ui,code-plugins,code-templates \
--temperature 0.2 --top_p 0.7 --max_new_tokens 512
EOF
    chmod +x "$HOME_DIR/start-webui.sh"

    # Vytvo≈ôen√≠ systemd slu≈æby
    cat << 'EOF' | sudo tee /etc/systemd/system/webui.service
[Unit]
Description=Text Generation WebUI (Code Czech Full)
After=network.target

[Service]
Type=simple
User=$USER_NAME
WorkingDirectory=$HOME_DIR/text-generation-webui
ExecStart=/bin/bash $HOME_DIR/start-webui.sh
Restart=on-failure
Environment=PYTHONUNBUFFERED=1

[Install]
WantedBy=multi-user.target
EOF

    sudo systemctl daemon-reload
    sudo systemctl enable webui.service
    echo "=== ‚úÖ Instalace AI serveru dokonƒçena! ==="
    echo "Spus≈•te WebUI p≈ô√≠kazem: ~/start-webui.sh"
    echo "Po restartu se spust√≠ automaticky. Dostupn√Ω na http://<IP_adresa_PC>:7860"
}

# --- Funkce pro instalaci virtu√°ln√≠ laborato≈ôe ---
install_kali_lab() {
    echo "=== üöÄ Spou≈°t√≠m instalaci Kali Labu (KVM, Docker) ==="
    LAB_HOME="$HOME_DIR/KaliLab"
    VM_NAME="KaliLabVM"
    DOCKER_NAME="kali-docker-gui"
    BRIDGE="br-lab"

    sudo apt-get update -y
    sudo apt-get upgrade -y
    sudo apt-get install -y qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils virt-manager docker.io docker-compose xfce4 xfce4-goodies tightvncserver websockify python3-flask python3-psutil

    sudo systemctl enable --now libvirtd docker
    sudo usermod -aG libvirt,docker "$USER_NAME"
    
    echo "=== Vytv√°≈ôen√≠ bridge s√≠tƒõ a NAT ==="
    if ! ip link show "$BRIDGE" &>/dev/null; then
        sudo ip link add name "$BRIDGE" type bridge
        sudo ip addr add 192.168.100.1/24 dev "$BRIDGE"
        sudo ip link set dev "$BRIDGE" up
        sudo iptables -t nat -A POSTROUTING -s 192.168.100.0/24 ! -d 192.168.100.0/24 -j MASQUERADE
    fi

    echo "=== P≈ô√≠prava KaliLab slo≈æky a sta≈æen√≠ QCOW2 obrazu ==="
    sudo -u "$USER_NAME" mkdir -p "$LAB_HOME"
    cd "$LAB_HOME"
    KALI_URL="https://images.kali.org/kali-rolling/kali-linux-2024.2-qemu-amd64.qcow2"
    if [ ! -f "$LAB_HOME/$VM_NAME.qcow2" ]; then
        sudo -u "$USER_NAME" wget -O "$LAB_HOME/$VM_NAME.qcow2" "$KALI_URL"
    fi

    echo "=== Vytvo≈ôen√≠ KVM VM ==="
    if ! virsh list --all | grep -q "$VM_NAME"; then
        virt-install --name "$VM_NAME" --ram 4096 --vcpus 2 \
        --disk path="$LAB_HOME/$VM_NAME.qcow2",format=qcow2 \
        --os-variant=debian11 --network bridge="$BRIDGE" \
        --graphics vnc,listen=0.0.0.0 --import --noautoconsole
    fi

    echo "=== Vytvo≈ôen√≠ Docker Kali GUI ==="
    if ! docker ps -a | grep -q "$DOCKER_NAME"; then
        docker pull kalilinux/kali-rolling
        docker network create --subnet="192.168.100.0/24" kali-net
        docker run -d --name "$DOCKER_NAME" --network kali-net -it kalilinux/kali-rolling /bin/bash
    fi

    echo "=== Instalace dashboardu ==="
    DASHBOARD_DIR="$LAB_HOME/dashboard"
    sudo -u "$USER_NAME" mkdir -p "$DASHBOARD_DIR"
    cd "$DASHBOARD_DIR"

    # Vytvo≈ôen√≠ Flask aplikace s bezpeƒçnƒõj≈°√≠m k√≥dem
    cat > app.py <<EOF
from flask import Flask, render_template, redirect, jsonify
import os, subprocess, psutil, libvirt, json

app = Flask(__name__)
VM_NAME = "KaliLabVM"
DOCKER_NAME = "kali-docker-gui"
NOVNC_PORT = "6080"

def get_vm_stats(vm):
    try:
        conn = libvirt.open(None)
        dom = conn.lookupByName(vm)
        info = dom.info()
        mem_percent = (info[2]/1024)/info[1]*100
        cpu_percent = info[3]/1e9
        return {"cpu": round(cpu_percent, 1), "mem": round(mem_percent, 1)}
    except:
        return {"cpu": 0, "mem": 0}

@app.route('/stats')
def stats():
    host_cpu = psutil.cpu_percent()
    host_mem = psutil.virtual_memory().percent
    vm_stats = get_vm_stats(VM_NAME)
    return jsonify({"host": {"cpu": host_cpu, "mem": host_mem}, "vm": vm_stats})

@app.route('/start_vm')
def start_vm():
    subprocess.run(['virsh', 'start', VM_NAME])
    return redirect('/')

# Zbytek k√≥du aplikace
# ...
EOF

    # Vytvo≈ôen√≠ HTML ≈°ablony
    sudo -u "$USER_NAME" mkdir -p templates
    cat > templates/index.html <<EOF
<!doctype html>
<html lang="en">
<head>
    <title>Kali Lab Dashboard</title>
</head>
<body>
    <h1>Kali Lab Dashboard</h1>
    <h2>KVM VM</h2>
    <a href="/start_vm">Start VM</a>
</body>
</html>
EOF

    echo "=== ‚úÖ Instalace virtu√°ln√≠ laborato≈ôe dokonƒçena! ==="
    echo "Spus≈•te dashboard p≈ô√≠kazem: cd $DASHBOARD_DIR && python3 app.py"
    echo "Dashboard je dostupn√Ω na http://<IP_adresa_PC>:5000"
}

# =========================================================================
# HLAVN√ç MENU
# =========================================================================

echo "=========================================="
echo "    Vyberte, co chcete nainstalovat:"
echo "=========================================="
echo "1. Starko PenTest Dashboard (Django, PostgreSQL, n√°stroje)"
echo "2. AI k√≥dovac√≠ server (text-generation-webui)"
echo "3. Virtu√°ln√≠ laborato≈ô (KVM, Docker, dashboard)"
echo "4. Nainstalovat v≈°e (v≈°echny 3 moduly)"
echo "------------------------------------------"
read -p "Zadejte ƒç√≠slo volby (1-4): " choice

case $choice in
    1)
        install_starko_suite
        ;;
    2)
        install_ai_suite
        ;;
    3)
        install_kali_lab
        ;;
    4)
        install_starko_suite
        install_ai_suite
        install_kali_lab
        ;;
    *)
        echo "Neplatn√° volba. Spus≈•te skript znovu a zadejte ƒç√≠slo od 1 do 4."
        exit 1
        ;;
esac

echo "‚úÖ V≈°echny vybran√© instalace byly dokonƒçeny. Dƒõkuji za pou≈æit√≠ skriptu."